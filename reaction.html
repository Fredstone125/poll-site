<!DOCTYPE html>
<html>
<head>
    <title>Reaction Time Test</title>
    <link rel="stylesheet" href="style.css">
</head>
<body style="text-align:center; font-family: Arial;">

<h1>Reaction Time Test</h1>

<button id="startBtn">Start</button>

<div id="box" 
     style="width:200px;height:200px;background:red;margin:40px auto;cursor:pointer;">
</div>

<h2 id="messageDisplay"></h2>
<h2 id="timeDisplay"></h2>

<button id="resetBtn" style="display:none;">Play Again</button>
<button id="saveBtn" style="display:none;">Save to Leaderboard</button>

<hr style="margin:40px 0;">

<h2>Leaderboard</h2>
<div id="leaderboard"></div>

<script>
const startBtn = document.getElementById("startBtn");
const box = document.getElementById("box");
const timeDisplay = document.getElementById("timeDisplay");
const messageDisplay = document.getElementById("messageDisplay");
const resetBtn = document.getElementById("resetBtn");
const saveBtn = document.getElementById("saveBtn");
const leaderboardDiv = document.getElementById("leaderboard");

let startTime;
let timeout;
let finalTime = null;
let gameState = "idle"; 
// idle → waiting → ready → finished

function resetGame() {
    box.style.background = "red";
    timeDisplay.textContent = "";
    messageDisplay.textContent = "";
    startBtn.style.display = "inline-block";
    resetBtn.style.display = "none";
    saveBtn.style.display = "none";
    gameState = "idle";
}

startBtn.addEventListener("click", () => {
    startBtn.style.display = "none";
    gameState = "waiting";

    const randomDelay = Math.random() * 3000 + 1000;

    timeout = setTimeout(() => {
        box.style.background = "green";
        startTime = performance.now();
        gameState = "ready";
    }, randomDelay);
});

box.addEventListener("click", () => {

    // If clicked too early
    if (gameState === "waiting") {
        clearTimeout(timeout);
        messageDisplay.textContent = "Too Early! You failed.";
        resetBtn.style.display = "inline-block";
        gameState = "finished";
        return;
    }

    // If clicked correctly
    if (gameState === "ready") {
        const reactionTime = performance.now() - startTime;
        finalTime = parseFloat((reactionTime / 1000).toFixed(3));
        timeDisplay.textContent = finalTime + " seconds";
        resetBtn.style.display = "inline-block";
        saveBtn.style.display = "inline-block";
        box.style.background = "red";
        gameState = "finished";
    }
});

resetBtn.addEventListener("click", resetGame);

saveBtn.addEventListener("click", async () => {
    if (!finalTime) return;

    let name = prompt("Enter your name:");
    if (!name) return;

    name = name.trim().toLowerCase();
    if (!name) return;

    await fetch('/api/saveReaction', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            name,
            time: finalTime
        })
    });

    loadLeaderboard();
    saveBtn.style.display = "none";
});

async function loadLeaderboard() {
    const res = await fetch('/api/getLeaderboard');
    const data = await res.json();

    let html = "<ol>";
    data.forEach(player => {
        html += `<li>${player.name} — ${player.time} sec</li>`;
    });
    html += "</ol>";

    leaderboardDiv.innerHTML = html;
}

loadLeaderboard();
</script>
<div class="button-container">
    <a href="index.html" class="home-btn">Back to Home</a>
</div>
</body>
</html>
