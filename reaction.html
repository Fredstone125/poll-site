<!DOCTYPE html>
<html>
<head>
    <title>Reaction Time Test</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body style="text-align:center; font-family: Arial;">

<h1>Reaction Time Test</h1>

<button id="startBtn">Start</button>

<div id="box" 
     style="width:200px;height:200px;background:red;margin:40px auto;cursor:pointer;">
</div>

<h2 id="waitDisplay"></h2>
<h2 id="timeDisplay"></h2>

<button id="resetBtn" style="display:none;">Play Again</button>
<button id="saveBtn" style="display:none;">Save to Leaderboard</button>

<hr style="margin:40px 0;">

<h2>Leaderboard</h2>
<div id="leaderboard"></div>

<script>
const startBtn = document.getElementById("startBtn");
const box = document.getElementById("box");
const timeDisplay = document.getElementById("timeDisplay");
const resetBtn = document.getElementById("resetBtn");
const saveBtn = document.getElementById("saveBtn");
const leaderboardDiv = document.getElementById("leaderboard");

let startTime;
let timeout;
let finalTime = null;

function resetGame() {
    box.style.background = "red";
    timeDisplay.textContent = "";
    startBtn.style.display = "inline-block";
    resetBtn.style.display = "none";
    saveBtn.style.display = "none";
}

startBtn.addEventListener("click", () => {
    startBtn.style.display = "none";

    const randomDelay = Math.random() * 3000 + 1000;

    timeout = setTimeout(() => {
        box.style.background = "green";
        startTime = performance.now();
    }, randomDelay);
});

box.addEventListener("click", () => {
    if (box.style.background === "green") {
        const reactionTime = performance.now() - startTime;
        finalTime = parseFloat((reactionTime / 1000).toFixed(3));
        timeDisplay.textContent = finalTime + " seconds";
        resetBtn.style.display = "inline-block";
        saveBtn.style.display = "inline-block";
        box.style.background = "red";
    }
});

resetBtn.addEventListener("click", resetGame);

saveBtn.addEventListener("click", async () => {
    if (!finalTime) return;

    let name = prompt("Enter your name:");

    if (!name) return;
    
    name = name.trim().toLowerCase();

    if (!name) return;

    await fetch('/api/saveReaction', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            name: name.trim(),
            time: finalTime
        })
    });

    loadLeaderboard();
    saveBtn.style.display = "none";
});

async function loadLeaderboard() {
    const res = await fetch('/api/getLeaderboard');
    const data = await res.json();

    let html = "<ol>";
    data.forEach(player => {
        html += `<li>${player.name} â€” ${player.time} sec</li>`;
    });
    html += "</ol>";

    leaderboardDiv.innerHTML = html;
}

loadLeaderboard();
</script>

</body>
</html>
